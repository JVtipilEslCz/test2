<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evidenční systém půjčovny</title>
    
    <!-- Firebase SDK pro použití modulů -->
    <script type="module">
        // Importy pro Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
        import { getDatabase, ref, set, get, child, onValue } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-database.js";

        // Firebase konfigurace
        const firebaseConfig = {
            apiKey: "AIzaSyDff7I609AeT2bpdjIKewdAtzfPvOr8Hg4",
            authDomain: "test2-c4d26.firebaseapp.com",
            databaseURL: "https://test2-c4d26-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "test2-c4d26",
            storageBucket: "test2-c4d26.firebasestorage.app",
            messagingSenderId: "696702216457",
            appId: "1:696702216457:web:54cf142e7a63fcecb88bd8"
        };

        // Inicializace Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Funkce pro přidání zařízení do databáze
window.addDevice = function() {
    let name = document.getElementById("deviceName").value;
    if (!name) return;
    
    const newDevice = {
        name,
        status: "Dostupné",
        loanedBy: "",
        loanedTo: "",
        loanDate: ""
    };

    // Místo set() použijeme push() pro přidání nového zařízení
    const devicesRef = ref(db, 'devices');
    const newDeviceRef = push(devicesRef); // Generuje unikátní ID pro každé zařízení
    set(newDeviceRef, newDevice).then(() => {
        console.log("Zařízení bylo přidáno");
        renderDevices(); // Aktualizace seznamu zařízení po přidání
    }).catch((error) => {
        console.error("Chyba při přidávání zařízení:", error);
    });
};

// Funkce pro vykreslení všech zařízení
window.renderDevices = function() {
    const list = document.getElementById("deviceList");
    list.innerHTML = "";  // Vymazání seznamu, než se vykreslí nový obsah

    const devicesRef = ref(db, 'devices');

    // Použití onValue pro získání všech zařízení v reálném čase
    onValue(devicesRef, (snapshot) => {
        if (snapshot.exists()) {
            snapshot.forEach(childSnapshot => {
                const device = childSnapshot.val();
                let li = document.createElement("li");
                li.innerHTML = `${device.name} (${childSnapshot.key}) - ${device.status}` +
                    `<br>Kdo půjčil: ${device.loanedBy || "-"}` +
                    `<br>Komu půjčil: ${device.loanedTo || "-"}` +
                    `<br>Datum zápůjčky: ${device.loanDate || "-"}` +
                    `<br><button onclick="loanDevice('${childSnapshot.key}')">Půjčit</button>` +
                    `<button onclick="returnDevice('${childSnapshot.key}')">Vrátit</button>` +
                    `<div id="qrcode-${childSnapshot.key}"></div>`;
                list.appendChild(li);
                new QRCode(document.getElementById(`qrcode-${childSnapshot.key}`), childSnapshot.key);
            });
        } else {
            list.innerHTML = "Žádná zařízení nebyla nalezena.";
        }
    });
}

        // Funkce pro půjčení zařízení
        window.loanDevice = function(id) {
            let deviceRef = ref(db, 'devices/' + id);
            get(deviceRef).then((snapshot) => {
                if (snapshot.exists()) {
                    let device = snapshot.val();
                    let loanedBy = prompt("Kdo půjčil?");
                    let loanedTo = prompt("Komu půjčil?");
                    let loanDate = new Date().toLocaleDateString("cs-CZ");
                    if (loanedBy && loanedTo) {
                        device.status = "Půjčeno";
                        device.loanedBy = loanedBy;
                        device.loanedTo = loanedTo;
                        device.loanDate = loanDate;
                        set(deviceRef, device); // Aktualizace zařízení v databázi
                    }
                }
            });
        }

        // Funkce pro vrácení zařízení
        window.returnDevice = function(id) {
            let deviceRef = ref(db, 'devices/' + id);
            get(deviceRef).then((snapshot) => {
                if (snapshot.exists()) {
                    let device = snapshot.val();
                    device.status = "Dostupné";
                    device.loanedBy = "";
                    device.loanedTo = "";
                    device.loanDate = "";
                    set(deviceRef, device); // Aktualizace zařízení v databázi
                }
            });
        }

        // Načítání zařízení při načtení stránky
        renderDevices();
    </script>
    
    <style>
        body { font-family: Calibri, sans-serif; }
    </style>
</head>
<body>
    <h1>Evidenční systém půjčovny</h1>
    
    <button onclick="startScanner()">Spustit skener</button>
    <video id="video" width="300" height="200" autoplay></video>
    <p id="scannerStatus"></p>
    
    <h2>Přidat nové zařízení</h2>
    <input type="text" id="deviceName" placeholder="Název zařízení">
    <button onclick="addDevice()">Přidat</button>
    
    <h2>Seznam zařízení</h2>
    <ul id="deviceList"></ul>
</body>
</html>
