<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evidenční systém půjčovny</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body {
            font-family: Calibri, sans-serif;
            margin: 20px;
        }

        h1 {
            text-align: center;
        }

        /* Flexbox pro rozložení zařízení a QR kódu */
        .container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-top: 20px;
        }

        .device-list {
            flex: 2;
        }

        .qr-code {
            flex: 1;
            text-align: center;
        }

        button {
            margin-top: 10px;
        }

        #video {
            width: 300px;
            height: 200px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <h1>Evidenční systém půjčovny</h1>
    
    <button onclick="startScanner()">Spustit skener</button>
    <video id="video" width="300" height="200" autoplay></video>
    <p id="scannerStatus"></p>

    <div class="container">
        <div class="device-list">
            <h2>Přidat nové zařízení</h2>
            <input type="text" id="deviceName" placeholder="Název zařízení">
            <button onclick="addDevice()">Přidat</button>

            <h2>Seznam zařízení</h2>
            <ul id="deviceList"></ul>
        </div>

        <div class="qr-code">
            <h2>QR Kódy</h2>
            <div id="qrcode-container"></div>
        </div>
    </div>

    <script>
        // Firebase inicializace a nastavení, jak jsme již probírali
        const firebaseConfig = {
            apiKey: "your-api-key",
            authDomain: "your-auth-domain",
            databaseURL: "https://your-database-url.firebaseio.com",
            projectId: "your-project-id",
            storageBucket: "your-storage-bucket",
            messagingSenderId: "your-messaging-sender-id",
            appId: "your-app-id"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const devicesRef = ref(db, 'devices');

        let devices = [];
        let filteredDevices = [];
        let scanning = false;
        let videoStream = null;

        function addDevice() {
            const name = document.getElementById("deviceName").value;
            if (!name) return;

            const id = "DEV" + Math.floor(Math.random() * 10000);
            const newDevice = { id, name, status: "Dostupné", loanedBy: "", loanedTo: "", loanDate: "" };

            // Uložení zařízení do Firebase
            set(ref(db, 'devices/' + id), newDevice)
                .then(() => {
                    console.log("Zařízení bylo přidáno");
                    renderDevices();
                }).catch((error) => {
                    console.error("Chyba při přidávání zařízení:", error);
                });
        }

        function renderDevices() {
            const list = document.getElementById("deviceList");
            list.innerHTML = "";
            filteredDevices.forEach(device => {
                const li = document.createElement("li");
                li.innerHTML = `${device.name} (${device.id}) - ${device.status}` +
                    `<br>Kdo půjčil: ${device.loanedBy || "-"}` +
                    `<br>Komu půjčil: ${device.loanedTo || "-"}` +
                    `<br>Datum zápůjčky: ${device.loanDate || "-"}` +
                    `<br><button onclick="loanDevice('${device.id}')">Půjčit</button>` +
                    `<button onclick="returnDevice('${device.id}')">Vrátit</button>` +
                    `<br><div id="qrcode-${device.id}"></div>`;
                list.appendChild(li);
                new QRCode(document.getElementById(`qrcode-${device.id}`), device.id);
            });
        }

        function loanDevice(id) {
            const deviceRef = ref(db, 'devices/' + id);
            get(deviceRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const deviceData = snapshot.val();
                    const loanedBy = prompt("Kdo půjčil?");
                    const loanedTo = prompt("Komu půjčil?");
                    const loanDate = new Date().toLocaleDateString("cs-CZ");

                    if (loanedBy && loanedTo) {
                        update(deviceRef, {
                            name: deviceData.name,  // Uchováme jméno
                            status: "Půjčeno",
                            loanedBy,
                            loanedTo,
                            loanDate
                        }).then(() => {
                            console.log("Zařízení bylo půjčeno");
                            renderDevices();
                        }).catch((error) => {
                            console.error("Chyba při půjčování zařízení:", error);
                        });
                    }
                }
            }).catch((error) => {
                console.error("Chyba při načítání zařízení:", error);
            });
        }

        function returnDevice(id) {
            const deviceRef = ref(db, 'devices/' + id);
            get(deviceRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const deviceData = snapshot.val();
                    update(deviceRef, {
                        name: deviceData.name,  // Uchováme jméno
                        status: "Dostupné",
                        loanedBy: "",
                        loanedTo: "",
                        loanDate: ""
                    }).then(() => {
                        console.log("Zařízení bylo vráceno");
                        renderDevices();
                    }).catch((error) => {
                        console.error("Chyba při vrácení zařízení:", error);
                    });
                }
            }).catch((error) => {
                console.error("Chyba při načítání zařízení:", error);
            });
        }

        function startScanner() {
            if (scanning) return;
            scanning = true;
            document.getElementById("scannerStatus").innerText = "Spouštím skener...";

            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(stream => {
                videoStream = stream;
                let video = document.getElementById("video");
                video.srcObject = stream;
                let canvas = document.createElement("canvas");
                let ctx = canvas.getContext("2d");
                document.getElementById("scannerStatus").innerText = "Skenování...";

                function scan() {
                    if (!scanning) return;
                    if (video.readyState === video.HAVE_ENOUGH_DATA) {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        let code = jsQR(imageData.data, canvas.width, canvas.height);
                        if (code) {
                            let device = devices.find(d => d.id === code.data);
                            if (device) {
                                filteredDevices = [device];
                                renderDevices();
                                // Přesměrování na detail zařízení
                                window.location.href = `#device-${device.id}`;
                                stopScanner();
                            }
                        }
                    }
                    requestAnimationFrame(scan);
                }
                scan();
            }).catch(err => {
                document.getElementById("scannerStatus").innerText = "Nepodařilo se spustit kameru. Zkontrolujte oprávnění.";
                scanning = false;
            });
        }

        function stopScanner() {
            scanning = false;
            document.getElementById("scannerStatus").innerText = "Skener zastaven.";
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
        }

        // Načítání zařízení z Firebase
        onValue(devicesRef, (snapshot) => {
            devices = [];
            snapshot.forEach((childSnapshot) => {
                devices.push(childSnapshot.val());
            });
            filteredDevices = [...devices];
            renderDevices();
        });

    </script>
</body>
</html>
